<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Privado com Tokens Variáveis</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
  <h2>Chat Privado - Teste com Tokens</h2>

  <label>Token:</label>
  <input type="text" id="tokenInput" placeholder="Cole seu JWT aqui" size="80"/>
  <button onclick="connect()">Conectar</button>
  <button onclick="disconnect()">Desconectar</button>

  <br/><br/>
  <label>Para:</label>
  <input type="text" id="toInput" placeholder="Nome do usuário destino"/>
  <label>Mensagem:</label>
  <input type="text" id="messageInput" placeholder="Digite a mensagem"/>
  <button onclick="sendMessage()">Enviar</button>

  <h3>Mensagens Recebidas:</h3>
  <ul id="messages"></ul>

  <script>
    let stompClient = null;

    const messagesList = document.getElementById("messages");

    function connect() {
      const token = document.getElementById("tokenInput").value.trim();
      if (!token) return alert("Insira um token!");

      // Conectar SockJS + STOMP
      const socket = new SockJS("http://localhost:8080/ws?token=" + token);
      stompClient = Stomp.over(socket);
      stompClient.debug = null; // desativa logs STOMP

      stompClient.connect({}, frame => {
        console.log("Conectado:", frame);

        // Limpar mensagens antigas
        messagesList.innerHTML = "";

        // Subscrição da fila privada
        stompClient.subscribe("/user/queue/messages", msg => {
          const li = document.createElement("li");
          const payload = JSON.parse(msg.body);
          li.textContent = `De ${payload.from}: ${payload.content}`;
          messagesList.appendChild(li);
        });

        // Subscrição opcional de fila pública
        stompClient.subscribe("/queue/public", msg => {
          const li = document.createElement("li");
          li.textContent = `Publica: ${msg.body}`;
          messagesList.appendChild(li);
        });
      });
    }

    function disconnect() {
      if (stompClient !== null) {
        stompClient.disconnect(() => console.log("Desconectado"));
      }
      stompClient = null;
      messagesList.innerHTML = "";
    }

    function sendMessage() {
      if (!stompClient || !stompClient.connected) return alert("Conecte primeiro!");

      const to = document.getElementById("toInput").value.trim();
      const content = document.getElementById("messageInput").value.trim();

      if (!to || !content) return alert("Preencha todos os campos!");

      const payload = { to: to, content: content };

      stompClient.send("/app/send", {}, JSON.stringify(payload));

      document.getElementById("messageInput").value = "";
    }
  </script>
</body>
</html>
